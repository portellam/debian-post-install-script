#!/bin/false

#
# Filename:         lib-software
# Description:      Download software packages and Git repositories.
# Author(s):        Alex Portell <github.com/portellam>
# Maintainer(s):    Alex Portell <github.com/portellam>
#

# <sources>
    source lib-datatypes
    source lib-system
# </sources>

# <functions>
    function SetParameters
    {
        if [[ ! -z "${_ARE_PARAMS_SET_LIB_SOFTWARE}" ]] \
            && "${_ARE_COMMON_PARAMS_SET}"; then
            return 0
        fi

        declare -gr _ARE_PARAMS_SET_LIB_SOFTWARE=true

        declare -gr _LIST_OF_OPERATING_SYSTEMS_WITH_APT_DELIM="debian bodhi deepin knoppix mint peppermint pop ubuntu kubuntu lubuntu xubuntu"
        declare -gr _LIST_OF_OPERATING_SYSTEMS_WITH_DNF_OR_YUM_DELIM="redhat alma berry centos cern clearos elastix fedora fermi frameos mageia opensuse oracle scientific suse"
        declare -gr _LIST_OF_OPERATING_SYSTEMS_WITH_PACMAN_DELIM="arch manjaro"
        declare -gr _LIST_OF_OPERATING_SYSTEMS_WITH_PORTAGE_DELIM="gentoo"
        declare -gr _LIST_OF_OPERATING_SYSTEMS_WITH_URPMI_DELIM="opensuse"
        declare -gr _LIST_OF_OPERATING_SYSTEMS_WITH_ZYPPER_DELIM="mandriva mageia"

        declare -gl _COMMAND_LIST_PACKAGE=""
        declare -gl _COMMAND_INSTALL_PACKAGE=""
        declare -gl _COMMAND_UNINSTALL_PACKAGE=""
        declare -gl _PACKAGE_MANAGER=""

        declare -g _PACMAN_IS_APT=false
        declare -g _PACMAN_IS_DNF=false
        declare -g _PACMAN_IS_PACMAN=false
        declare -g _PACMAN_IS_PORTAGE=false
        declare -g _PACMAN_IS_URPMI=false
        declare -g _PACMAN_IS_YUM=false
        declare -g _PACMAN_IS_ZYPPER=false
        declare -g _PACMAN_IS_UNKNOWN=false

        # <remarks> Functions can go here. </remarks>
        GetPackageManager
        GetCommandToInstallPackage
        GetCommandToListPackage
        GetCommandToUninstallPackage
        # IsThisLinuxDistributionSupported

        declare -r _COMMAND_LIST_PACKAGE _COMMAND_INSTALL_PACKAGE _COMMAND_UNINSTALL_PACKAGE _PACKAGE_MANAGER
    }

    function FindPackage
    {
        if [[ -z "${_COMMAND_LIST_PACKAGE}" ]]; then
            return 1
        fi

        eval "${_COMMAND_LIST_PACKAGE} ${1}"
        # PrintSuffixPassOrFail "Searching software packages..."
        return "${?}"
    }

    function GetCommandToInstallPackage
    {
        case true in
            "${_PACMAN_IS_APT}" )
                _COMMAND_INSTALL_PACKAGE="apt update && apt full-upgrade -y && apt install -y " ;;

            "${_PACMAN_IS_DNF}" )
                _COMMAND_INSTALL_PACKAGE="dnf upgrade && dnf install " ;;

            "${_PACMAN_IS_PACMAN}" )
                _COMMAND_INSTALL_PACKAGE="pacman -Syu && pacman -S " ;;

            "${_PACMAN_IS_PORTAGE}" )
                _COMMAND_INSTALL_PACKAGE="merge -u @world && emerge " ;;

            "${_PACMAN_IS_URPMI}" )
                _COMMAND_INSTALL_PACKAGE="urpmi --auto-update && urpmi " ;;

            "${_PACMAN_IS_YUM}" )
                _COMMAND_INSTALL_PACKAGE="yum update && yum install " ;;

            "${_PACMAN_IS_ZYPPER}" )
                _COMMAND_INSTALL_PACKAGE="zypper refresh && zypper in " ;;

            "${_PACMAN_IS_UNKNOWN}" )
                return 1 ;;
        esac

        return 0
    }

    function GetCommandToListPackage
    {
        case true in
            "${_PACMAN_IS_APT}" )
                _COMMAND_LIST_PACKAGE="apt list " ;;

            "${_PACMAN_IS_DNF}" )
                _COMMAND_LIST_PACKAGE="dnf search " ;;

            "${_PACMAN_IS_PACMAN}" )
                _COMMAND_LIST_PACKAGE="pacman -Ss " ;;

            "${_PACMAN_IS_PORTAGE}" )
                _COMMAND_LIST_PACKAGE="emerge --search " ;;

            "${_PACMAN_IS_URPMI}" )
                _COMMAND_LIST_PACKAGE="urpme " ;;

            "${_PACMAN_IS_YUM}" )
                _COMMAND_LIST_PACKAGE="yum search " ;;

            "${_PACMAN_IS_ZYPPER}" )
                _COMMAND_LIST_PACKAGE="zypper se " ;;

            "${_PACMAN_IS_UNKNOWN}" )
                return 1 ;;
        esac

        return 0
    }

    function GetCommandToUninstallPackage
    {
        case true in
            "${_PACMAN_IS_APT}" )
                _COMMAND_UNINSTALL_PACKAGE="apt uninstall " ;;

            "${_PACMAN_IS_DNF}" )
                _COMMAND_UNINSTALL_PACKAGE="dnf remove " ;;

            "${_PACMAN_IS_PACMAN}" )
                _COMMAND_UNINSTALL_PACKAGE="pacman -R " ;;

            "${_PACMAN_IS_PORTAGE}" )
                _COMMAND_UNINSTALL_PACKAGE="emerge -Cv " ;;

            "${_PACMAN_IS_URPMI}" )
                _COMMAND_UNINSTALL_PACKAGE="urpme " ;;

            "${_PACMAN_IS_YUM}" )
                _COMMAND_UNINSTALL_PACKAGE="yum remove " ;;

            "${_PACMAN_IS_ZYPPER}" )
                _COMMAND_UNINSTALL_PACKAGE="zypper remove " ;;

            "${_PACMAN_IS_UNKNOWN}" )
                return 1 ;;
        esac

        return 0
    }

    function GetPackageManager
    {
        if [[ "${_LIST_OF_OPERATING_SYSTEMS_WITH_APT_DELIM}" =~ .*${_OPERATING_SYSTEM_DISTRIBUTION_NAME}.* ]]; then
            _PACMAN_IS_APT=true

        elif [[ "${_LIST_OF_OPERATING_SYSTEMS_WITH_DNF_OR_YUM_DELIM}" =~ .*${_OPERATING_SYSTEM_DISTRIBUTION_NAME}.* ]]; then
            if command -v "${_PACKAGE_MANAGER}"; then
                _PACMAN_IS_DNF=true
                return 0
            fi

            _PACMAN_IS_YUM=true

        elif [[ "${_LIST_OF_OPERATING_SYSTEMS_WITH_PACMAN_DELIM}" =~ .*${_OPERATING_SYSTEM_DISTRIBUTION_NAME}.* ]]; then
            _PACMAN_IS_PACMAN=true

        elif [[ "${_LIST_OF_OPERATING_SYSTEMS_WITH_PORTAGE_DELIM}" =~ .*${_OPERATING_SYSTEM_DISTRIBUTION_NAME}.* ]]; then
            _PACMAN_IS_PORTAGE=true

        elif [[ "${_LIST_OF_OPERATING_SYSTEMS_WITH_URPMI_DELIM}" =~ .*${_OPERATING_SYSTEM_DISTRIBUTION_NAME}.* ]]; then
            _PACMAN_IS_URPMI=true

        elif [[ "${_LIST_OF_OPERATING_SYSTEMS_WITH_ZYPPER_DELIM}" =~ .*${_OPERATING_SYSTEM_DISTRIBUTION_NAME}.* ]]; then
            _PACMAN_IS_ZYPPER=true

        else
            _PACMAN_IS_UNKNOWN=true
            return 1
        fi

        return 0
    }

    function IsThisLinuxDistributionSupported
    {
        local KERNEL="$( uname -o | tr '[:upper:]' '[:lower:]' )"

        if [[ -z "${KERNEL}" ]]; then
            echo -e "${_PREFIX_ERROR} Failed to parse system kernel."
            return 1
        fi

        if [[ -z "${_OPERATING_SYSTEM_DISTRIBUTION_NAME}" ]]; then
            echo -e "${_PREFIX_ERROR} Failed to parse operating system."
            return 1
        fi

        if [[ "${KERNEL}" != *"linux"* ]]; then
            echo -e "${_PREFIX_ERROR} Kernel '$( uname -o )' is not supported."
            return 1
        fi

        if "${_PACMAN_IS_UNKNOWN}"; then
            echo -e "${_PREFIX_ERROR} Distribution '$( lsb_release -is )' is not supported."
            return 1
        fi

        return 0
    }

    function InstallPackage
    {
        local -n LIST_REFERENCE="${1}"
        local DELIM=""

        if IsEnum "LIST_REFERENCE"; then
            SetGivenDelimitedStringFromEnum "LIST_REFERENCE" "DELIM" " "
        else
            DELIM="${LIST_REFERENCE}"
        fi

        if [[ -z "${_COMMAND_INSTALL_PACKAGE}" ]]; then
            return 1
        fi

        eval "${_COMMAND_INSTALL_PACKAGE} ${DELIM}"
        # PrintSuffixPassOrFail "Installing software packages..."
        return "${?}"
    }

    function IsInstalledPackage
    {
        if [[ -z "${1}" ]]; then
            echo -e "${_PREFIX_ERROR} Input values are empty."
            return 1
        fi

        local GET_COMMAND=""

        # <remarks> Check if package is not installed </remarks>
        case true in
            "${_PACMAN_IS_APT}" )
                GET_COMMAND="sudo dpkg -s" ;;

            * )
                return 1 ;;
        esac

        local -i COUNT_DELIM=$( echo "${1}" | wc -w )
        local GET_PACKAGE='echo "${1}" | cut -d ' ' -f "${COUNT_DELIM}"'

        while [[ ! -z "${PACKAGE}" ]]; do
            local PACKAGE=$( eval "${GET_PACKAGE}" )
            eval "${GET_COMMAND} ${PACKAGE}" || return 1
            (( COUNT_DELIM-- ))
        done

        return 0
    }

    function ReadPackagesFromFile
    {
        local -n PACKAGE_LIST_REFERENCE="${1}"
        local FILE_NAME="${2}"

        while read -r LINE; do
            if [[ ! -z "${LINE}" ]] \
                && [[ "${LINE}" != "#"* ]]; then
                PACKAGE_LIST_REFERENCE+="${LINE}"
            fi
        done <<< "${FILE_NAME}"

        [ "${#PACKAGE_LIST_REFERENCE[@]}" -gt 0 ]
        return "${?}"
    }

    function UninstallPackage
    {
        local -n LIST_REFERENCE="${1}"
        local DELIM=""

        if IsEnum "LIST_REFERENCE"; then
            SetGivenDelimitedStringFromEnum "LIST_REFERENCE" "DELIM" " "
        else
            DELIM="${LIST_REFERENCE}"
        fi

        if [[ -z "${_COMMAND_INSTALL_PACKAGE}" ]]; then
            return 1
        fi

        eval "${_COMMAND_UNINSTALL_PACKAGE} ${DELIM}"
        # PrintSuffixPassOrFail "Uninstalling software packages..."
        return "${?}"
    }

    function UpdateGitRepo
    {
        if [[ ! -d "${1}${2}" ]] \
            && ! sudo mkdir -p "${1}${3}"; then
            echo -e "${_PREFIX_ERROR} Failed to create directory '${1}${3}'."
            return 1
        fi

        if [[ -d "${1}${2}" ]]; then
            cd "${1}${2}"

            if ! git pull &> /dev/null; then
                echo -e "${_PREFIX_ERROR} Failed to update repository."
                return 1
            fi

            return 0

        elif [[ -d "${1}${3}" ]]; then
            if ! git clone "https://github.com/${2}" &> /dev/null; then
                echo -e "${_PREFIX_ERROR} Failed to clone repository."
                return 1
            fi

        else
            return 1
        fi
    }
# </functions>

# <main>
    SetParameters
    unset SetParameters
# </main>